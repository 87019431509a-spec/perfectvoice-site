<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>
<title>PerfectVoice AI</title>
<style>
:root{--bg:#0B0C10;--card:#12131A;--text:#fff;--muted:#A6A8B3;--accent:#8B5CF6;--accent2:#9D7BFF;--line:#1c1d26;}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);color:var(--text);font-family:-apple-system,BlinkMacSystemFont,Arial,sans-serif;min-height:100vh;display:flex;justify-content:center;align-items:flex-start;padding:16px}
.app{width:100%;max-width:440px;background:var(--card);border-radius:20px;padding:22px;box-shadow:0 0 40px rgba(0,0,0,.6)}
h1{margin:0 0 6px;font-size:26px}
.sub{color:var(--muted);font-size:14px;margin-bottom:18px}
label{font-size:12px;color:var(--muted);display:block;margin:12px 0 6px}
select,textarea,input{width:100%;background:#0f1016;border:1px solid var(--line);border-radius:12px;padding:12px;color:var(--text);font-size:14px}
textarea{resize:none}
.row{display:flex;gap:8px}
.btn{flex:1;padding:12px;border-radius:12px;border:1px solid var(--line);background:#0f1016;color:var(--text);font-size:14px}
.btn.active{background:linear-gradient(135deg,var(--accent),var(--accent2));border:none}
.cta{width:100%;margin-top:14px;padding:14px;border:none;border-radius:14px;font-size:16px;color:#fff;background:linear-gradient(135deg,var(--accent),var(--accent2))}
.secondary{width:100%;margin-top:10px;padding:12px;border:1px solid var(--line);border-radius:14px;font-size:15px;color:#fff;background:#0f1016}
.grid2{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-top:10px}
.badge{display:inline-flex;gap:8px;align-items:center;color:var(--muted);font-size:12px}
.status{margin-top:12px;color:var(--muted);font-size:13px;line-height:1.35}
.card{margin-top:16px;border-top:1px solid var(--line);padding-top:14px}
.hidden{display:none}
pre{white-space:pre-wrap;background:#0f1016;border:1px solid var(--line);padding:12px;border-radius:12px;color:#d9d9ff;font-size:13px}
.cover{width:100%;aspect-ratio:1/1;border-radius:16px;background:linear-gradient(135deg,#1c1d26,#0f1016);overflow:hidden;border:1px solid var(--line)}
.cover img{width:100%;height:100%;object-fit:cover;display:block}
.small{font-size:12px;color:var(--muted)}
a{color:#cbbcff}
</style>
</head>
<body>
<div class="app">
  <h1>PerfectVoice AI</h1>
  <div class="sub">–ü—Ä–µ–º–∏–∞–ª—å–Ω–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –ø–µ—Å–µ–Ω ‚Ä¢ –≤–æ–∫–∞–ª ‚Ä¢ –æ–±–ª–æ–∂–∫–∏</div>

  <div class="badge">üåê <span id="apiState">API: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ</span></div>

  <label>–ñ–∞–Ω—Ä</label>
  <select id="genre"></select>

  <label>–¢–µ–º–ø</label>
  <div class="row" id="tempoRow">
    <button class="btn active" data-tempo="auto">üéõ –ê–≤—Ç–æ</button>
    <button class="btn" data-tempo="slow">–ú–µ–¥–ª–µ–Ω–Ω—ã–π</button>
    <button class="btn" data-tempo="fast">–ë—ã—Å—Ç—Ä—ã–π</button>
  </div>

  <label>–ì–æ–ª–æ—Å</label>
  <div class="row" id="voiceRow">
    <button class="btn active" data-voice="male">üë® –ú—É–∂—Å–∫–æ–π</button>
    <button class="btn" data-voice="female">üë© –ñ–µ–Ω—Å–∫–∏–π</button>
  </div>

  <label>–†–µ–∂–∏–º —Ç–µ–∫—Å—Ç–∞</label>
  <div class="row" id="modeRow">
    <button class="btn active" data-mode="ai">ü§ñ –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –ò–ò</button>
    <button class="btn" data-mode="user">‚úèÔ∏è –°–≤–æ–π —Ç–µ–∫—Å—Ç</button>
  </div>

  <label id="ideaLabel">–ò–¥–µ—è (‚â§ 500)</label>
  <textarea id="idea" rows="4" placeholder="–û–ø–∏—à–∏ –∏–¥–µ—é –ø–µ—Å–Ω–∏‚Ä¶"></textarea>

  <button class="cta" id="btnText">–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å —Ç–µ–∫—Å—Ç</button>

  <div class="grid2">
    <button class="secondary" id="btnDemo">üéµ DEMO (40s)</button>
    <button class="secondary" id="btnFull">üí≥ –ü–æ–ª–Ω–∞—è –≤–µ—Ä—Å–∏—è</button>
  </div>

  <div class="status" id="status">–°—Ç–∞—Ç—É—Å: –≥–æ—Ç–æ–≤</div>

  <div class="card hidden" id="textCard">
    <div class="small">–¢–µ–∫—Å—Ç –≥–æ—Ç–æ–≤:</div>
    <pre id="lyrics"></pre>
  </div>

  <div class="card hidden" id="resultCard">
    <div class="small">–†–µ–∑—É–ª—å—Ç–∞—Ç:</div>
    <div class="cover" id="coverBox"></div>
    <div style="height:10px"></div>
    <audio id="a1" controls style="width:100%"></audio>
    <div style="height:8px"></div>
    <audio id="a2" controls style="width:100%"></audio>
  </div>

  <div class="card">
    <div class="small">–ü–æ–¥—Å–∫–∞–∑–∫–∞:</div>
    <div class="small">–ß—Ç–æ–±—ã —Å–∞–π—Ç —Ä–∞–±–æ—Ç–∞–ª –∫–∞–∫ –±–æ—Ç ‚Äî –Ω—É–∂–µ–Ω backend API –Ω–∞ PythonAnywhere. –Ø –¥–∞—é –∫–æ–¥ –Ω–∏–∂–µ.</div>
  </div>
</div>

<script>
/** === –ù–ê–°–¢–†–û–ô–ö–ê ===
 * 1) –ü–æ–¥–Ω–∏–º–∏ API –Ω–∞ PythonAnywhere
 * 2) –í–ø–∏—à–∏ —Å—é–¥–∞ –∞–¥—Ä–µ—Å, –Ω–∞–ø—Ä–∏–º–µ—Ä:
 *    const API_BASE = "https://perfectvoice.pythonanywhere.com";
 */
const API_BASE = "https://perfectvoice.pythonanywhere.com";
const GENRES = [
  "üé§ –ü–æ–ø","üé∏ –†–æ–∫","üî• –†–µ–ø","üé∂ –•–∏–ø-—Ö–æ–ø","üéπ –≠–ª–µ–∫—Ç—Ä–æ–Ω–∏–∫–∞","üéµ –®–∞–Ω—Å–æ–Ω","üòé –†–æ–∑—ã–≥—Ä—ã—à",
  "üåë –¢—ë–º–Ω—ã–π —É—Ä–±–∞–Ω","üåÉ –ö–∏–±–µ—Ä-—Ä–æ–º–∞–Ω—Ç–∏–∫–∞","‚ùÑÔ∏è –•–æ–ª–æ–¥–Ω—ã–π —Ç–µ—Ö–Ω–æ","üé∏ –ê–∫—É—Å—Ç–∏—á–µ—Å–∫–∏–π –Ω—É–∞—Ä",
  "üèôÔ∏è –ì–æ—Ä–æ–¥—Å–∫–∞—è —ç–ª–µ–≥–∏—è","üî© –°—Ç–∞–ª—å–Ω–æ–π –¥—Ä–∞–º-—Ñ–ª–æ—É"
];

const WAIT_TEXT = [
  "‚è≥ –û–∂–∏–¥–∞–π—Ç–µ‚Ä¶ —Å–æ–±–∏—Ä–∞—é –∞—Ç–º–æ—Å—Ñ–µ—Ä—É –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—É —Ç—Ä–µ–∫–∞.",
  "üß† –û–∂–∏–¥–∞–π—Ç–µ‚Ä¶ —à–ª–∏—Ñ—É—é —Ä–∏—Ñ–º—ã, —á—Ç–æ–±—ã –∑–≤—É—á–∞–ª–æ –¥–æ—Ä–æ–≥–æ.",
  "üéõ –û–∂–∏–¥–∞–π—Ç–µ‚Ä¶ –Ω–∞—Å—Ç—Ä–∞–∏–≤–∞—é —Ç–µ–º–ø –∏ –ø–æ–¥–∞—á—É –ø–æ–¥ –∂–∞–Ω—Ä.",
  "üéß –û–∂–∏–¥–∞–π—Ç–µ‚Ä¶ –¥–µ–ª–∞—é –ø—Ä–∏–ø–µ–≤ —Ü–µ–ø–∫–∏–º –∏ –ø–æ—é—â–∏–º—Å—è.",
  "‚ú® –û–∂–∏–¥–∞–π—Ç–µ‚Ä¶ –¥–æ–±–∞–≤–ª—è—é ¬´–≤–∞—É¬ª-—ç—Ñ—Ñ–µ–∫—Ç."
];

const WAIT_MUSIC = [
  "üé∂ –û–∂–∏–¥–∞–π—Ç–µ‚Ä¶ –∑–∞–ø—É—Å–∫–∞—é –≥–µ–Ω–µ—Ä–∞—Ü–∏—é –º—É–∑—ã–∫–∏.",
  "üé§ –û–∂–∏–¥–∞–π—Ç–µ‚Ä¶ –ø–æ–¥–±–∏—Ä–∞—é —Ç–µ–º–±—Ä –∏ –¥–∏–Ω–∞–º–∏–∫—É –≤–æ–∫–∞–ª–∞.",
  "üíø –û–∂–∏–¥–∞–π—Ç–µ‚Ä¶ —Å–æ–±–∏—Ä–∞—é –∞—Ä–∞–Ω–∂–∏—Ä–æ–≤–∫—É, —á—Ç–æ–±—ã –∫–∞—á–∞–ª–æ.",
  "‚ö° –û–∂–∏–¥–∞–π—Ç–µ‚Ä¶ —Ñ–∏–Ω–∞–ª—å–Ω–∞—è –ø–æ–ª–∏—Ä–æ–≤–∫–∞ –∑–≤—É–∫–∞.",
  "üõ∞ –û–∂–∏–¥–∞–π—Ç–µ‚Ä¶ Suno —É–∂–µ –≤ –¥–µ–ª–µ, —Å–µ–∫—É–Ω–¥–æ—á–∫—É."
];

let state = {
  genre: GENRES[0],
  tempo: "auto",
  voice: "male",
  mode: "ai",
  full_text: ""
};

function pick(arr){ return arr[Math.floor(Math.random()*arr.length)] }
function setStatus(t){ document.getElementById("status").innerText = "–°—Ç–∞—Ç—É—Å: " + t; }
function setApiState(ok){
  document.getElementById("apiState").innerText = ok ? "API: –ø–æ–¥–∫–ª—é—á–µ–Ω–æ" : "API: –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ";
}

function setActive(containerId, attr, value){
  document.querySelectorAll(`#${containerId} .btn`).forEach(b=>{
    b.classList.toggle("active", b.getAttribute(attr)===value);
  });
}

function renderGenres(){
  const sel = document.getElementById("genre");
  sel.innerHTML = GENRES.map(g=>`<option>${g}</option>`).join("");
  sel.value = state.genre;
  sel.onchange = ()=> state.genre = sel.value;
}

function renderMode(){
  const label = document.getElementById("ideaLabel");
  const ta = document.getElementById("idea");
  if(state.mode==="ai"){
    label.innerText = "–ò–¥–µ—è (‚â§ 500)";
    ta.placeholder = "–û–ø–∏—à–∏ –∏–¥–µ—é –ø–µ—Å–Ω–∏‚Ä¶";
  } else {
    label.innerText = "–¢–µ–∫—Å—Ç –ø–µ—Å–Ω–∏ (–ø–æ–ª–Ω–æ—Å—Ç—å—é)";
    ta.placeholder = "–í—Å—Ç–∞–≤—å —Å–≤–æ–π —Ç–µ–∫—Å—Ç‚Ä¶";
  }
}

async function apiPost(path, payload){
  if(!API_BASE) throw new Error("API_BASE empty");
  const r = await fetch(API_BASE + path, {
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify(payload)
  });
  if(!r.ok) throw new Error("HTTP " + r.status);
  return await r.json();
}

async function apiGet(path){
  if(!API_BASE) throw new Error("API_BASE empty");
  const r = await fetch(API_BASE + path);
  if(!r.ok) throw new Error("HTTP " + r.status);
  return await r.json();
}

async function pollJob(jobId){
  // –æ–∂–∏–¥–∞–µ–º, –ø–æ–∫–∞ backend –æ—Ç–¥–∞—Å—Ç DONE/ERROR
  for(;;){
    const j = await apiGet(`/api/job/${jobId}`);
    if(j.status==="DONE" || j.status==="ERROR") return j;
    setStatus(j.stage || j.status);
    await new Promise(res=>setTimeout(res, 1500));
  }
}

async function genText(){
  const input = document.getElementById("idea").value.trim();
  if(!input) return alert("–ù—É–∂–Ω–æ –∑–∞–ø–æ–ª–Ω–∏—Ç—å –ø–æ–ª–µ.");

  document.getElementById("resultCard").classList.add("hidden");
  document.getElementById("textCard").classList.add("hidden");
  setStatus(pick(WAIT_TEXT) + " (–æ—á–µ—Ä–µ–¥—å‚Ä¶)");

  if(!API_BASE){
    // fallback –±–µ–∑ API (—Ç–æ–ª—å–∫–æ —á—Ç–æ–±—ã UI –Ω–µ –±—ã–ª –º—ë—Ä—Ç–≤—ã–º)
    setApiState(false);
    setTimeout(()=>{
      state.full_text = "‚ö†Ô∏è API –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ.\n\n–°–µ–π—á–∞—Å —ç—Ç–æ –¥–µ–º–æ-—Ä–µ–∂–∏–º –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.\n–ü–æ–¥–Ω–∏–º–∏ backend –Ω–∞ PythonAnywhere ‚Äî –∏ –±—É–¥–µ—Ç 1:1 –∫–∞–∫ –±–æ—Ç.";
      document.getElementById("lyrics").innerText = state.full_text;
      document.getElementById("textCard").classList.remove("hidden");
      setStatus("—Ç–µ–∫—Å—Ç –≥–æ—Ç–æ–≤ (–¥–µ–º–æ UI)");
    }, 1200);
    return;
  }

  setApiState(true);

  try{
    const res = await apiPost("/api/text", {
      idea: input.slice(0,500),
      genre: state.genre,
      tempo: state.tempo,
      voice: state.voice
    });
    // res: { job_id }
    const done = await pollJob(res.job_id);
    if(done.status==="ERROR") throw new Error(done.error||"error");
    state.full_text = done.result.full_text || "";
    document.getElementById("lyrics").innerText = state.full_text;
    document.getElementById("textCard").classList.remove("hidden");
    setStatus("—Ç–µ–∫—Å—Ç –≥–æ—Ç–æ–≤");
  }catch(e){
    setStatus("–æ—à–∏–±–∫–∞ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏ —Ç–µ–∫—Å—Ç–∞");
    alert("–û—à–∏–±–∫–∞: " + e.message);
  }
}

async function runDemo(){
  if(!state.full_text){
    // –µ—Å–ª–∏ —Ä–µ–∂–∏–º "user" ‚Äî –±–µ—Ä—ë–º —Ç–µ–∫—Å—Ç –∏–∑ –ø–æ–ª—è
    if(state.mode==="user"){
      state.full_text = document.getElementById("idea").value.trim();
    }
  }
  if(!state.full_text) return alert("–°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π/–ø–æ–ª—É—á–∏ —Ç–µ–∫—Å—Ç.");

  setStatus(pick(WAIT_MUSIC) + " (DEMO, –æ—á–µ—Ä–µ–¥—å‚Ä¶)");

  if(!API_BASE){
    setApiState(false);
    setTimeout(()=>{
      document.getElementById("coverBox").innerHTML = "";
      document.getElementById("a1").src = "";
      document.getElementById("a2").src = "";
      document.getElementById("resultCard").classList.remove("hidden");
      setStatus("–≥–æ—Ç–æ–≤–æ (–¥–µ–º–æ UI –±–µ–∑ API)");
    }, 1300);
    return;
  }

  setApiState(true);

  try{
    const res = await apiPost("/api/demo", {
      text: state.full_text,
      genre: state.genre,
      voice: state.voice
    });
    const done = await pollJob(res.job_id);
    if(done.status==="ERROR") throw new Error(done.error||"error");

    const { cover_url, audio_urls } = done.result;
    if(cover_url){
      document.getElementById("coverBox").innerHTML = `<img src="${cover_url}" alt="cover">`;
    } else {
      document.getElementById("coverBox").innerHTML = "";
    }
    document.getElementById("a1").src = (audio_urls && audio_urls[0]) ? audio_urls[0] : "";
    document.getElementById("a2").src = (audio_urls && audio_urls[1]) ? audio_urls[1] : "";
    document.getElementById("resultCard").classList.remove("hidden");
    setStatus("–≥–æ—Ç–æ–≤–æ (DEMO)");
  }catch(e){
    setStatus("–æ—à–∏–±–∫–∞ DEMO");
    alert("–û—à–∏–±–∫–∞: " + e.message);
  }
}

async function runFull(){
  if(!state.full_text){
    if(state.mode==="user"){
      state.full_text = document.getElementById("idea").value.trim();
    }
  }
  if(!state.full_text) return alert("–°–Ω–∞—á–∞–ª–∞ —Å–¥–µ–ª–∞–π/–ø–æ–ª—É—á–∏ —Ç–µ–∫—Å—Ç.");

  setStatus(pick(WAIT_MUSIC) + " (FULL, –æ—á–µ—Ä–µ–¥—å‚Ä¶)");

  if(!API_BASE){
    setApiState(false);
    alert("FULL —Ç—Ä–µ–±—É–µ—Ç backend API (–∏ –ø–æ–∑–∂–µ –æ–ø–ª–∞—Ç—É). –°–µ–π—á–∞—Å API –Ω–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–æ.");
    return;
  }

  setApiState(true);

  try{
    const res = await apiPost("/api/full", {
      text: state.full_text,
      genre: state.genre,
      voice: state.voice
    });
    const done = await pollJob(res.job_id);
    if(done.status==="ERROR") throw new Error(done.error||"error");

    const { cover_url, audio_urls } = done.result;
    if(cover_url){
      document.getElementById("coverBox").innerHTML = `<img src="${cover_url}" alt="cover">`;
    } else {
      document.getElementById("coverBox").innerHTML = "";
    }
    document.getElementById("a1").src = (audio_urls && audio_urls[0]) ? audio_urls[0] : "";
    document.getElementById("a2").src = (audio_urls && audio_urls[1]) ? audio_urls[1] : "";
    document.getElementById("resultCard").classList.remove("hidden");
    setStatus("–≥–æ—Ç–æ–≤–æ (FULL)");
  }catch(e){
    setStatus("–æ—à–∏–±–∫–∞ FULL");
    alert("–û—à–∏–±–∫–∞: " + e.message);
  }
}

document.getElementById("tempoRow").onclick = (e)=>{
  const b = e.target.closest("button"); if(!b) return;
  state.tempo = b.dataset.tempo;
  setActive("tempoRow","data-tempo",state.tempo);
};
document.getElementById("voiceRow").onclick = (e)=>{
  const b = e.target.closest("button"); if(!b) return;
  state.voice = b.dataset.voice;
  setActive("voiceRow","data-voice",state.voice);
};
document.getElementById("modeRow").onclick = (e)=>{
  const b = e.target.closest("button"); if(!b) return;
  state.mode = b.dataset.mode;
  setActive("modeRow","data-mode",state.mode);
  state.full_text = "";
  document.getElementById("textCard").classList.add("hidden");
  renderMode();
};

document.getElementById("btnText").onclick = ()=>{
  if(state.mode==="ai") genText();
  else {
    // user mode: "—Ç–µ–∫—Å—Ç –≥–æ—Ç–æ–≤" —Å—Ä–∞–∑—É
    const t = document.getElementById("idea").value.trim();
    if(!t) return alert("–í—Å—Ç–∞–≤—å —Ç–µ–∫—Å—Ç.");
    state.full_text = t;
    document.getElementById("lyrics").innerText = t;
    document.getElementById("textCard").classList.remove("hidden");
    setStatus("—Ç–µ–∫—Å—Ç —Å–æ—Ö—Ä–∞–Ω—ë–Ω");
  }
};
document.getElementById("btnDemo").onclick = runDemo;
document.getElementById("btnFull").onclick = runFull;

renderGenres();
renderMode();
</script>
</body>
</html>
